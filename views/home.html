<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>To-Do</title>

    <link href="../css/styles.css" rel="stylesheet" type="text/css" />

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.js"></script>
    <script src="//fb.me/react-0.10.0.js"></script>
    <script src="//fb.me/JSXTransformer-0.10.0.js"></script>
</head>
<body>

<div class="container">
    <header>
    </header>
    <section id="main">
    </section>
    <footer>
    </footer>

</div>

<script type="text/jsx">
    /** @jsx React.DOM */

    var List = React.createClass({
        getInitialState: function() {
            return { items: [] };
        },

        componentDidMount: function() {
            $.get(this.props.source, function(result) {
                var items = {};
                result.map(function(item) {
                    items[item.id] = item;
                });
                this.setState({ items: items });
            }.bind(this));
        },

        addItem: function(newItemValue, callback) {
            var items = this.state.items;
            var newItemData = {
                // TODO: fix this
                index: 0,
                value: newItemValue,
                checked: false
            };

            $.post(this.props.source, newItemData, function(data) {
                items[data.id] = data;
                this.setState({ items: items }, function() {
                    console.log('added new item:');
                    console.log(data);
                    if (typeof callback === 'function') {
                        callback(data);
                    }
                });
            }.bind(this));
        },

        removeItem: function(id) {
            console.log('deleting items[' + id + ']');
            var deleteTarget = this.state.items[id];
            console.log(this.state.items);
            if (!deleteTarget) {
                console.log('no target');
                return;
            }

            $.ajax({
                type: 'DELETE',
                url: this.props.source + '/' + deleteTarget.id,
                success: function() {
                    var items = this.state.items;
                    delete items[id];
                    this.setState({ items: items });
                }.bind(this)
            });
        },

        updateItem: function(newData, callback) {
            console.log(newData);
            $.ajax({
                type: 'PUT',
                url: this.props.source + '/' + newData.id,
                data: newData,
                success: function(data) {
                    var items = this.state.items;
                    items[newData.id] = data;
                    this.setState({ items: items }, function() {
                        if (typeof callback === 'function') {
                            callback(data);
                        }
                    });
                }.bind(this)
            });
        },

        render: function() {
            var items = this.state.items;
            var deleteCallback = this.removeItem;
            var saveCallback = this.addItem;
            var updateCallback = this.updateItem;

            console.log(items);

            return (
                <ol className="list">
                    {Object.keys(items).map(function(id) {
                        return (
                            <Item key={id}
                                initialData={items[id]}
                                deleteCallback={deleteCallback}
                                updateCallback={updateCallback}
                            />
                        );
                    })}
                    <ItemNewField saveCallback={saveCallback} />
                </ol>
            );
        }
    });

    var ItemNewField = React.createClass({
        getInitialState: function() {
            return { value: '' };
        },

        onKeyPress: function(evt) {
            if (evt.keyCode === 13) {
                this.save();
            }
        },

        handleChange: function(evt) {
            this.setState({ value: evt.target.value });
        },

        save: function() {
            if (!this.state.value) {
                return;
            }
            this.props.saveCallback(this.state.value, function() {
                this.setState(this.getInitialState());
            }.bind(this));
        },

        render: function() {
            return (<li><div><input
                type="text"
                className="new-field"
                placeholder="New item"
                onChange={this.handleChange}
                onBlur={this.save}
                onKeyPress={this.onKeyPress}
                value={this.state.value}
            /></div></li>);
        }
    });

    var ItemField = React.createClass({
        getInitialState: function() {
            return {
                value: this.props.initialValue,
                oldValue: this.props.initialValue,
                editMode: false
            };
        },

        onKeyPress: function(evt) {
            if (evt.keyCode === 13) {
                this.save();
            }
        },

        handleClick: function(evt) {
            this.enableEditMode();
        },

        enableEditMode: function() {
            this.setState({
                oldValue: this.state.value,
                editMode: true
            });
        },

        disableEditMode: function() {
            this.setState({ editMode: false });
        },

        handleChange: function(evt) {
            this.setState({ value: evt.target.value });
        },

        save: function() {
            if (this.state.value == this.state.oldValue) {
                this.disableEditMode();
                return;
            }
            var newData = {
                id: this.props.id,
                value: this.state.value
            };
            this.props.updateCallback(newData, function() {
                this.disableEditMode();
            }.bind(this));
        },

        render: function() {
            if (this.state.editMode) {
                return (
                    <div>
                        <input
                            type="text"
                            onChange={this.handleChange}
                            onBlur={this.save}
                            onKeyPress={this.onKeyPress}
                            value={this.state.value}
                        />
                        <DeleteButton
                            id={this.props.id}
                            deleteCallback={this.props.deleteCallback}
                        />
                    </div>
                );
            }

            return <div onClick={this.handleClick}>{this.state.value}</div>
        }
    });

    var Item = React.createClass({
        getInitialState: function() {
            return this.props.initialData;
        },

        render: function() {
            return (
                <li>
                    <ItemCheckbox
                        id={this.state.id}
                        initialValue={this.state.checked}
                        updateCallback={this.props.updateCallback}
                    />
                    <ItemField
                        id={this.state.id}
                        initialValue={this.state.value}
                        updateCallback={this.props.updateCallback}
                        deleteCallback={this.props.deleteCallback}
                    />
                </li>
            );
        }
    });

    var ItemCheckbox = React.createClass({
        getInitialState: function() {
            return { checked : Boolean(this.props.initialValue) };
        },

        handleChange: function(evt) {
            this.setState({ checked : !this.state.checked }, function() {
                this.save();
            });
        },

        save: function() {
            this.props.updateCallback({
                id: this.props.id,
                checked: this.state.checked
            });
        },

        render: function() {
            return (
                <input type="checkbox" checked={this.state.checked} onChange={this.handleChange} />
            );
        }
    });

    var DeleteButton = React.createClass({
        fire: function() {
            this.props.deleteCallback(this.props.id);
        },
        render: function() {
            return <a className="delete" onClick={this.fire}>X</a>
        },
    });


    React.renderComponent(
        <List source="/api/items" />,
        document.getElementById('main')
    );
</script>

</body>
</html>
