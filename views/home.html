<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>To-Do</title>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.js"></script>
    <script src="//fb.me/react-0.10.0.js"></script>
    <script src="//fb.me/JSXTransformer-0.10.0.js"></script>
</head>
<body>

<div class="container">
    <header>
    </header>
    <section id="main">
    </section>
    <footer>
    </footer>

</div>

<script type="text/jsx">
    /** @jsx React.DOM */

    var List = React.createClass({
        getInitialState: function() {
            return { items: [] };
        },

        componentDidMount: function() {
            $.get(this.props.source, function(result) {
                this.setState({ items: result });
            }.bind(this));
        },

        addItem: function(newItemValue) {
            var items = this.state.items;
            var newItemData = {
                index: items.length,
                value: newItemValue,
                checked: false
            };

            $.post(this.props.source, newItemData, function(data) {
                items.push(data);
                this.setState({ items: items });
                console.log('added new item');
                console.log(data);
            }.bind(this));
        },

        removeItem: function(index) {
            console.log('deleting items[' + index + ']');
            var deleteTarget = this.state.items[index];
            if (!deleteTarget) {
                return;
            }

            $.ajax({
                type: 'DELETE',
                url: this.props.source + '/' + deleteTarget._id,
                success: function() {
                    var items = this.state.items;
                    delete items[index];
                    this.setState({ items: items });
                }.bind(this)
            });
        },

        render: function() {
            var items = this.state.items;
            var deleteCallback = this.removeItem;
            var saveCallback = this.addItem;

            console.log(items);

            return (
                <ol className="list">
                    {items.map(function(item) {
                        return (
                            <Item key={item._id}
                                initialData={item}
                                deleteCallback={deleteCallback}
                            />
                        );
                    })}
                    <Item key="newItem"
                        initialData={{
                            value: <NewItemField
                                index={items.length}
                                saveCallback={saveCallback}
                            />
                        }}
                    />
                </ol>
            );
        }
    });

    var NewItemField = React.createClass({
        getInitialState: function() {
            return {value:''};
        },

        handleChange: function(evt) {
            this.setState({ value: evt.target.value });
        },

        save: function() {
            this.props.saveCallback(this.state.value);
            this.setState(this.getInitialState());
        },

        render: function() {
            return (<input type="text"
                placeholder="New item"
                onChange={this.handleChange}
                onBlur={this.save}
                value={this.state.value}
            />);
        }
    });

    var DeleteButton = React.createClass({
        fire: function() {
            this.props.callback(this.props.index);
        },
        render: function() {
            return <a onClick={this.fire}>X</a>
        },
    });


    var Item = React.createClass({
        getInitialState: function() {
            return this.props.initialData;
        },

        render: function() {
            return (
                <li>
                    {this.state.value}
                    <DeleteButton
                        index={this.state.index}
                        callback={this.props.deleteCallback}
                    />
                </li>
            );
        }
    });


    React.renderComponent(
        <List source="/api/items" />,
        document.getElementById('main')
    );
</script>

</body>
</html>
