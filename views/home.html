<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>To-Do</title>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.js"></script>
    <script src="//fb.me/react-0.10.0.js"></script>
    <script src="//fb.me/JSXTransformer-0.10.0.js"></script>
</head>
<body>

<div class="container">
    <header>
    </header>
    <section id="main">
    </section>
    <footer>
    </footer>

</div>

<script type="text/jsx">
    /** @jsx React.DOM */

    var List = React.createClass({
        getInitialState: function() {
            return {items:[]};
        },

        componentDidMount: function() {
            $.get(this.props.source, function(result) {
                console.log(result);
                this.setState({
                    items: result
                });
            }.bind(this));
        },

        addNewItem: function(data) {
            var items = this.state.items;
            items.push(data);
            this.setState({items:items});
            console.log(this.state.items);
        },

        render: function() {
            var items = this.state.items;
            var newItemFieldData = {
                value: <NewItemField
                    target={this.props.source}
                    index={items.length}
                    afterSave={this.addNewItem}
                />
            };

            return (
                <ol className="list">
                    {items.map(function(item) {
                        return <Item key={item._id} initialData={item} />;
                    })}
                    <Item key="newItem" initialData={newItemFieldData} />
                </ol>
            );
        }
    });

    var NewItemField = React.createClass({
        getInitialState: function() {
            return {value:''};
        },

        handleChange: function(evt) {
            this.setState({value: evt.target.value});
        },

        save: function() {
            var newItemData = {
                index: this.props.index,
                value: this.state.value,
                checked: false
            }
            $.post(this.props.target, newItemData, function(data) {
                this.props.afterSave(data);
                this.setState(this.getInitialState());
            }.bind(this));
        },

        render: function() {
            return (<input type="text"
                placeholder="New item"
                onChange={this.handleChange}
                onBlur={this.save}
                value={this.state.value}
            />);
        }
    });

    var Item = React.createClass({
        getInitialState: function() {
            return this.props.initialData;
        },

        render: function() {
            return (
                <li>{this.state.value}</li>
            );
        }
    });


    React.renderComponent(
        <List source="/api/items" />,
        document.getElementById('main')
    );
</script>

</body>
</html>
